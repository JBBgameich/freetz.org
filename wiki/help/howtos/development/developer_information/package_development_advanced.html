<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  


  <head>
    <title>
      help/howtos/development/developer_information/package_development_advanced – Freetz
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="help" href="../../../../TracGuide.html" />
        <link rel="alternate" href="package_development_advanced%3Fformat=txt" type="text/x-trac-wiki" title="Reiner Text" />
        <link rel="up" href="../developer_information.html" title="Übergeordnete Wiki-Seite anzeigen" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="../../../../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/common/css/wiki.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/wikiextras/css/phrases.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/wikiextras/css/boxes.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/wikiextras/css/boxes-300.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/wikiextras/css/boxes-narrow-toc.css" type="text/css" /><link rel="stylesheet" href="../../../../../wikicss.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/tags/css/tractags.css" type="text/css" /><link rel="stylesheet" href="../../../../../chrome/wikinegotiator/css/langmenu-ctxnav.css" type="text/css" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Freetz durchsuchen" />
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/messages/de.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="../../../../../chrome/common/js/folding.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="/wiki"><img src="../../../../../chrome/common/freetz_motd.png" alt="Freetz" /></a>
      </div>
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Suche:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Suche" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Anmelden</a></li><li><a href="/prefs">Einstellungen</a></li><li><a href="../../../../TracGuide.html">Hilfe/Anleitung</a></li><li><a href="/about">Über Trac</a></li><li><a href="/notification" title="Wiki Pages Change Notifications">My Notifications</a></li><li><a href="/register">Registrieren</a></li><li class="last"><a href="../../../../Impressum.html">Impressum</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="/wiki">Wiki</a></li><li><a href="/timeline">Journal</a></li><li><a href="/roadmap">Projektplan</a></li><li><a href="/browser">Quellen durchsehen</a></li><li><a href="/report">Tickets anzeigen</a></li><li><a href="/search">Suche</a></li><li><a href="/tags">Tags</a></li><li><a href="/downloads">Downloads</a></li><li class="last"><a href="/screenshots">Bildschirmfotos</a></li>
    </ul>
  </div>
    <div id="langmenu"><ul><li class="first"><span title="Select a language of wiki content">Language:</span></li><li class=" active"><a class="" href="package_development_advanced..html" title="displaying language (default)">German</a></li><li class=" last"><a class=" notexist" href="/wiki/help/howtos/development/developer_information/package_development_advanced.en" title="(not available)">English</a></li></ul></div><div id="main">
      <div id="pagepath" class="noprint">
  <a class="pathentry first" title="Zeige WikiStart an" href="/wiki">Wiki:</a><a class="pathentry" href="../../../../help.html" title="Zeige help an">help</a><span class="pathentry sep">/</span><a class="pathentry" href="../../../howtos.html" title="Zeige help/howtos an">howtos</a><span class="pathentry sep">/</span><a class="pathentry" href="../../development.html" title="Zeige help/howtos/development an">development</a><span class="pathentry sep">/</span><a class="pathentry" href="../developer_information.html" title="Zeige help/howtos/development/developer_information an">developer_information</a><span class="pathentry sep">/</span><a class="pathentry" href="package_development_advanced.html" title="Zeige help/howtos/development/developer_information/package_development_advanced an">package_development_advanced</a>
</div>
      <div id="ctxtnav" class="nav">
        <h2>Kontext-Navigation</h2>
        <ul>
          <li class="first"><a href="../developer_information.html">Aufwärts</a></li><li><a href="../../../../WikiStart.html">Startseite</a></li><li><a href="../../../../TitleIndex.html">Inhaltsverzeichnis</a></li><li><a href="package_development_advanced%3Faction=history.html">Änderungshistorie</a></li><li class="last"><a href="/notification/help/howtos/development/developer_information/package_development_advanced" title="Watch Page">Watch Page</a></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="wiki">
      <div class="wikipage searchable">
        
          <div id="wikipage" class="trac-content"><h1 id="PackageDeveloping-AdvancedTopics">Package Developing - Advanced Topics</h1>
<p>
This chapter deals with some advanced topics on creating freetz-packages. It assumes that you are already familiar with the basic concepts described <a class="wiki" href="package_development_start.html">here</a>.
</p>
<h2 id="Addingconditionalpatches">Adding conditional patches</h2>
<p>
If you'd like to add conditional patches which could be enabled/disable by the user via menuconfig, a good example is <a class="changeset" href="/changeset/11348" title="minidlna:
 * add (optional) support for German language (by SilentBob)
 * ...">r11348</a>
</p>
<h2 id="Addingmulti-binarypackages">Adding multi-binary packages</h2>
<p>
Imagine you would like to add a freetz-package for some set of tools developed within the same source tree and thus distributed together as a single tarball file. Furthermore, you would like the user to be able to select which tool should be included in the image and which not. The simple straightforward solution might look like this:
</p>
<p>
<tt>Config.in</tt>
</p>
<pre class="wiki">FREETZ_PACKAGE_FOO_BINARY1
    bool "include binary1"
    default n
    help
	Adds binary1 to the image

FREETZ_PACKAGE_FOO_BINARY2
    bool "include binary2"
    default n
    help
	Adds binary2 to the image

....

FREETZ_PACKAGE_FOO_BINARYN
    bool "include binaryN"
    default n
    help
	Adds binaryN to the image
</pre><p>
<tt>foo.mk</tt>
</p>
<pre class="wiki">$(call PKG_INIT_BIN, 0.0.1)
$(PKG)_SOURCE:=$(pkg)-$($(PKG)_VERSION).tar.gz
$(PKG)_SOURCE_MD5:=0123456789abcdef0123456789abcdef
$(PKG)_SITE:=http://www.foo.net/

$(PKG)_BINARY1 := $($(PKG)_DIR)/binary1
$(PKG)_TARGET_BINARY1 := $($(PKG)_DEST_DIR)/usr/bin/binary1
$(PKG)_BINARY2 := $($(PKG)_DIR)/binary2
$(PKG)_TARGET_BINARY2 := $($(PKG)_DEST_DIR)/usr/bin/binary2
...
$(PKG)_BINARYN := $($(PKG)_DIR)/binaryN
$(PKG)_TARGET_BINARYN := $($(PKG)_DEST_DIR)/usr/bin/binaryN

$(PKG_SOURCE_DOWNLOAD)
$(PKG_UNPACKED)
$(PKG_CONFIGURED_CONFIGURE)

$($(PKG)_BINARY1) $($(PKG)_BINARY2) ... $($(PKG)_BINARYN): $($(PKG)_DIR)/.configured
	PATH="$(TARGET_PATH)" \
	$(MAKE) -C $(FOO_DIR) \
	all

$($(PKG)_TARGET_BINARY1): $($(PKG)_BINARY1)
ifeq ($(strip $(FREETZ_PACKAGE_FOO_BINARY1)),y)
	$(INSTALL_BINARY_STRIP)
else
	$(RM) $@
endif

$($(PKG)_TARGET_BINARY2): $($(PKG)_BINARY2)
ifeq ($(strip $(FREETZ_PACKAGE_FOO_BINARY2)),y)
	$(INSTALL_BINARY_STRIP)
else
	$(RM) $@
endif

...

$($(PKG)_TARGET_BINARYN): $($(PKG)_BINARYN)
ifeq ($(strip $(FREETZ_PACKAGE_FOO_BINARYN)),y)
	$(INSTALL_BINARY_STRIP)
else
	$(RM) $@
endif

$(pkg):

$(pkg)-precompiled: $($(PKG)_TARGET_BINARY1) $($(PKG)_TARGET_BINARY2) ... $($(PKG)_TARGET_BINARYN)

$(pkg)-clean:
	-$(MAKE) -C $(FOO_DIR) clean

$(pkg)-uninstall:
	$(RM) $(FOO_TARGET_BINARY1) $(FOO_TARGET_BINARY2) ... $(FOO_TARGET_BINARYN)

$(PKG_FINISH)
</pre><p>
There is nothing wrong with this solution. It is perfectly suitable for packages providing two or three binaries. For packages providing more binaries you would however quickly realize that by adding new binary to the package you don't write any new code but actually copying and adjusting the old one (in software engineering this process is called code cloning and is advised to be avoided as it may inflate maintenance costs).
</p>
<p>
Make is a very powerful tool and allows the same task to be solved writing much less code by using <strong><em>patterns</em></strong> and the so called <strong><em>static pattern rules</em></strong>. Let's take a look at the real Makefile of the dosfstools package.
</p>
<p>
<a class="source" href="/browser/trunk/make/dosfstools/dosfstools.mk">dosfstools.mk</a><a class="trac-rawlink" href="/export/HEAD/trunk/make/dosfstools/dosfstools.mk" title="Download">​</a>
</p>
<pre class="wiki">$(call PKG_INIT_BIN, 3.0.5)
$(PKG)_SOURCE:=$(pkg)-$($(PKG)_VERSION).tar.gz
$(PKG)_SOURCE_MD5:=d48177cde9c6ce64333133424bf32912
$(PKG)_SITE:=http://www.daniel-baumann.ch/software/dosfstools

$(PKG)_BINARIES_ALL := dosfsck dosfslabel mkdosfs
$(PKG)_BINARIES := $(strip $(foreach binary,$($(PKG)_BINARIES_ALL),$(if $(FREETZ_PACKAGE_$(PKG)_$(shell echo $(binary) | tr [a-z] [A-Z])),$(binary))))
$(PKG)_BINARIES_BUILD_DIR := $($(PKG)_BINARIES:%=$($(PKG)_DIR)/%)
$(PKG)_BINARIES_TARGET_DIR := $($(PKG)_BINARIES:%=$($(PKG)_DEST_DIR)/usr/sbin/%)
$(PKG)_NOT_INCLUDED := $(patsubst %,$($(PKG)_DEST_DIR)/usr/sbin/%,$(filter-out $($(PKG)_BINARIES),$($(PKG)_BINARIES_ALL)))

# always compile with LFS enabled
$(PKG)_CFLAGS := $(subst $(CFLAGS_LARGEFILE),,$(TARGET_CFLAGS)) $(CFLAGS_LFS_ENABLED) -fomit-frame-pointer

$(PKG_SOURCE_DOWNLOAD)
$(PKG_UNPACKED)
$(PKG_CONFIGURED_NOP)

$($(PKG)_BINARIES_BUILD_DIR): $($(PKG)_DIR)/.configured
	PATH="$(TARGET_PATH)" \
		$(MAKE) -C $(DOSFSTOOLS_DIR) \
		CC="$(TARGET_CC)" \
		CFLAGS="$(DOSFSTOOLS_CFLAGS)" \
		all

$($(PKG)_BINARIES_TARGET_DIR): $($(PKG)_DEST_DIR)/usr/sbin/%: $($(PKG)_DIR)/%
	$(INSTALL_BINARY_STRIP)

$(pkg):

$(pkg)-precompiled: $($(PKG)_BINARIES_TARGET_DIR)

$(pkg)-clean:
	-$(MAKE) -C $(DOSFSTOOLS_DIR) clean

$(pkg)-uninstall:
	$(RM) $(DOSFSTOOLS_BINARIES_ALL:%=$(DOSFSTOOLS_DEST_DIR)/usr/sbin/%)

$(PKG_FINISH)
</pre><p>
This line
</p>
<pre class="wiki">$(PKG)_BINARIES_ALL := dosfsck dosfslabel mkdosfs
</pre><p>
simply defines a variable containing the names (just the names not the full paths) of all binaries of the package.
</p>
<p>
This next line
</p>
<pre class="wiki">$(PKG)_BINARIES := $(strip $(foreach binary,$($(PKG)_BINARIES_ALL),$(if $(FREETZ_PACKAGE_$(PKG)_$(shell echo $(binary) | tr [a-z] [A-Z])),$(binary))))
</pre><p>
is probably the most complex one in the whole makefile. It defines a variable containing the names of all binaries selected in menuconfig. This is done by iterating (<a class="ext-link" href="http://www.gnu.org/software/make/manual/make.html#Foreach-Function"><span class="icon">​</span>foreach</a> function) over the names of all binaries (<tt>$($(PKG)_BINARIES_ALL)</tt>) and evaluating the variable with dynamically constructed name <tt>FREETZ_PACKAGE_$(PKG)_$(shell echo $(binary) | tr [a-z] [A-Z])</tt>. The expression <tt>$(shell echo $(binary) | tr [a-z] [A-Z])</tt> is a simple invocation of <tt>tr</tt> program which returns the upper-cased binary name. In case the variable with dynamically constructed name evaluates to some non-empty value (the only possible non-empty value is <strong>y</strong>) the binary is added to the <tt>$(PKG)_BINARIES</tt> variable. For those of you who is familiar with other programming languages, this line is equivalent to the following pseudo-code:
</p>
<pre class="wiki">$(PKG)_BINARIES := {}; # {} represents an empty set
for binary in $($(PKG)_BINARIES_ALL); do
   if isNotEmpty($(FREETZ_PACKAGE_$(PKG)_$(UPPERCASED_BINARY_NAME))); then
      $(PKG)_BINARIES += $(binary);
   fi
done
</pre><p>
The outter <a class="ext-link" href="http://www.gnu.org/software/make/manual/make.html#Text-Functions"><span class="icon">​</span>strip</a> function ensures that $(PKG)_BINARIES remains empty if no binary at all is selected in menuconfig (the foreach function always adds spaces in between regardless of whether <tt>FREETZ_PACKAGE_$(PKG)_$(UPPERCASED_BINARY_NAME)</tt> evaluates to something non-empty or not).
</p>
<p>
The advantage of this line is that it is absolutely generic. It depends neither on the number of binaries the package provides nor on the package name. You could use it on your packages without a change and without actually understanding how exactly it does what it does.
</p>
<p>
The next two lines
</p>
<pre class="wiki">$(PKG)_BINARIES_BUILD_DIR := $($(PKG)_BINARIES:%=$($(PKG)_DIR)/%)
$(PKG)_BINARIES_TARGET_DIR := $($(PKG)_BINARIES:%=$($(PKG)_DEST_DIR)/usr/sbin/%)
</pre><p>
are absolutely identical in the sense of makefile techniques used. They both use a shorthand for the make <a class="ext-link" href="http://www.gnu.org/software/make/manual/make.html#Text-Functions"><span class="icon">​</span>patsubst</a> function. Each word in the list defined by <tt>$(PKG)_BINARIES</tt> variable matching the <tt>'%'</tt>-pattern is replaced with <tt>$($(PKG)_DIR)/%</tt>. I.e. provided <tt>$(PKG)_BINARIES</tt> is equal to <tt>'dosfsck mkdosfs'</tt>, <tt>$(PKG)_BINARIES_BUILD_DIR</tt> would be equal to <tt>'$($(PKG)_DIR)/dosfsck $($(PKG)_DIR)/mkdosfs'</tt> (see <a class="ext-link" href="http://www.gnu.org/software/make/manual/make.html#Text-Functions"><span class="icon">​</span>this</a> page for the explanations of what <tt>'%'</tt>-sign means when used in <strong>pattern</strong> and what it means when used in <strong>replacement</strong>). Both lines could also be written this way:
</p>
<pre class="wiki">$(PKG)_BINARIES_BUILD_DIR := $(addprefix $($(PKG)_DIR)/,$($(PKG)_BINARIES))
$(PKG)_BINARIES_TARGET_DIR := $(addprefix $($(PKG)_DEST_DIR)/,$($(PKG)_BINARIES))
</pre><p>
The next line
</p>
<pre class="wiki">$(PKG)_NOT_INCLUDED := $(patsubst %,$($(PKG)_DEST_DIR)/usr/sbin/%,$(filter-out $($(PKG)_BINARIES),$($(PKG)_BINARIES_ALL)))
</pre><p>
does absolutely the same as the line defining the <tt>$(PKG)_BINARIES_TARGET_DIR</tt> variable with the only difference that it contains the list of dosfstools-binaries not selected in menuconfig. This part of it
</p>
<pre class="wiki">$(filter-out $($(PKG)_BINARIES),$($(PKG)_BINARIES_ALL))
</pre><p>
computes the difference between the <tt>$(PKG)_BINARIES_ALL</tt> and <tt>$(PKG)_BINARIES</tt> sets, i.e. it contains all binaries contained in <tt>$(PKG)_BINARIES_ALL</tt> and not contained in <tt>$(PKG)_BINARIES</tt>.
</p>
<p>
The variable <tt>$(PKG)_NOT_INCLUDED</tt> has a special meaning in freetz framework. It is expected to contain a list of all package files to be excluded from the image. Defining this variable allows all explicit <tt>$(RM) $@</tt> lines existing in the 1st example to be removed. Freetz' build system will take care of removing unnecessary files.
</p>
<p>
The last fragment we take a look at is the following one:
</p>
<pre class="wiki">$($(PKG)_BINARIES_TARGET_DIR): $($(PKG)_DEST_DIR)/usr/sbin/%: $($(PKG)_DIR)/%
	$(INSTALL_BINARY_STRIP)
</pre><p>
It defines the so called <a class="ext-link" href="http://www.gnu.org/software/make/manual/make.html#Static-Pattern"><span class="icon">​</span>static pattern rule</a>, a rule which specifies multiple targets and constructs the prerequisite names for each target based on the target name. These two lines are _absolutely_ equivalent to the following ones from the 1st example, they are just a shorthand for them:
</p>
<pre class="wiki">$($(PKG)_TARGET_BINARY1): $($(PKG)_BINARY1)
	$(INSTALL_BINARY_STRIP)

$($(PKG)_TARGET_BINARY2): $($(PKG)_BINARY2)
	$(INSTALL_BINARY_STRIP)

...

$($(PKG)_TARGET_BINARYN): $($(PKG)_BINARYN)
	$(INSTALL_BINARY_STRIP)
</pre><p>
That is actually it. There is absolutely no magic behind it.
</p>
<p>
You might want to take a look at the Makefiles of the following packages: <a class="source" href="/browser/trunk/make/e2fsprogs/e2fsprogs.mk">e2fsprogs</a><a class="trac-rawlink" href="/export/HEAD/trunk/make/e2fsprogs/e2fsprogs.mk" title="Download">​</a>, <a class="source" href="/browser/trunk/make/lighttpd/lighttpd.mk">lighttpd</a><a class="trac-rawlink" href="/export/HEAD/trunk/make/lighttpd/lighttpd.mk" title="Download">​</a>, <a class="source" href="/browser/trunk/make/subversion/subversion.mk">subversion</a><a class="trac-rawlink" href="/export/HEAD/trunk/make/subversion/subversion.mk" title="Download">​</a>. They all use the techniques like those described above.
</p>
</div>
          
          <div class="trac-modifiedby">
            <span><a href="package_development_advanced%3Faction=diff&amp;version=4.html" title="Version 4 von cuma: freud...">zuletzt geändert</a> <a class="timeline" href="/timeline?from=2013-12-01T09%3A00%3A33Z&amp;precision=second" title="Siehe Journal am 01.12.2013 09:00:33">vor 5 Jahren</a></span>
            <span class="trac-print">Zuletzt geändert am 01.12.2013 09:00:33</span>
          </div>
        
        
      </div>
      

    </div>
    <div id="altlinks">
      <h3>In anderen Formaten herunterladen:</h3>
      <ul>
        <li class="last first">
          <a rel="nofollow" href="package_development_advanced%3Fformat=txt">Reiner Text</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="../../../../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Betrieben mit <a href="/about"><strong>Trac 1.0.1</strong></a><br />
        von <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right"><div class="field" align="right"><form action="https://www.paypal.com/cgi-bin/webscr" method="post"><input type="hidden" name="cmd" value="_donations"/><input type="hidden" name="business" value="spenden@freetz.org"/><input type="hidden" name="item_name" value="Freetz Entwickler-Team"/><input type="hidden" name="no_shipping" value="1"/><input type="hidden" name="return" value="http://freetz.org"/><input type="hidden" name="cn" value="Name oder IPPF-Pseudonym"/><input type="hidden" name="currency_code" value="EUR"/><input type="hidden" name="tax" value="0"/><input type="hidden" name="lc" value="DE"/><input type="hidden" name="bn" value="PP-DonationsBF"/><input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="Zahlen Sie mit PayPal - schnell, kostenlos und sicher!"/><img alt="" border="0" src="/pixel.gif" width="1" height="1"/></form></div></p>
    </div>
  </body>
</html>